<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
  <title>√Årea Administrativa</title>
</head>

<body class="dashboard">
<nav class="navbar">
  <div class="logo">Biblioteca</div>
  <ul class="navbar-links">
    <li><a href="#" onclick="trocarSecao('home')">Home</a></li>
    <li><a href="#" onclick="trocarSecao('livros')">Livros</a></li>
    <li><a href="#" onclick="trocarSecao('emprestimos')">Empr√©stimos</a></li>
    <li><a href="#" onclick="trocarSecao('usuarios')">Usu√°rios</a></li>
  </ul>
  <button type="button" class="sair" id="sair">Logout</button>
</nav>

<div class="dashboard-container">
  <!-- SECAO HOME -->
  <div id="home" class="secao ativa">
    <div class="cabecalho-dashboard"><h1>Bem-vindo √† Biblioteca Virtual</h1></div>
    <p>Escolha uma op√ß√£o do menu acima para come√ßar.</p>
  </div>

  <!-- SECAO LIVROS -->
  <div id="livros" class="secao">
    <div class="cabecalho-dashboard"><h1>Gerenciar Livros</h1></div>
    <div class="cards-dashboard">
      <div class="card">
        <h3>Adicionar Livro</h3>
        <p>Cadastrar novo livro</p>
        <button onclick="trocarSecao('adicionar-livro')">Adicionar</button>
      </div>
      <div class="card">
        <h3>Ver Todos</h3>
        <p>Lista completa</p>
        <button onclick="trocarSecao('listar-livros'); listarLivros();">Ver Lista</button>
      </div>
    </div>
  </div>

  <!-- SECAO ADICIONAR LIVRO -->
  <div id="adicionar-livro" class="secao">
    <div class="cabecalho-dashboard"><h1>Adicionar Novo Livro</h1></div>
    <div class="formulario-livro">
      <form id="form-livro">
        <div class="campo">
          <label for="googleBooksIdInput">Colar ID Google Books:</label>
          <input type="text" id="googleBooksIdInput" name="googleBooksId" placeholder="Cole o ID aqui" />
          <button type="button" onclick="preencherFormularioPorId()" class="botao-google">Buscar</button>
        </div>

        <div class="campo">
          <label for="title">T√≠tulo:</label>
          <input type="text" id="title" name="title" required />
        </div>

        <div class="campo">
          <label for="author">Autor:</label>
          <input type="text" id="author" name="author" required />
        </div>

        <div class="campo">
          <label for="publisher">Editora:</label>
          <input type="text" id="publisher" name="publisher" required />
        </div>

        <div class="campo">
          <label for="publishedDate">Ano de publica√ß√£o:</label>
          <input type="number" id="publishedDate" name="publishedDate" required />
        </div>

        <div class="campo">
          <label for="isbn">ISBN:</label>
          <input type="text" id="isbn" name="isbn" required />
        </div>

        <div class="campo">
          <label for="description">Descri√ß√£o:</label>
          <input type="text" id="description" name="description" required />
        </div>

        <div class="campo">
          <label for="pageCount">N√∫mero de p√°ginas:</label>
          <input type="number" id="pageCount" name="pageCount" required />
        </div>

        <div class="caixa-botoes">
          <button type="button" onclick="trocarSecao('livros')" class="botao-voltar">‚Üê Voltar</button>
          <button type="submit" class="botaoo-salvar">üíæ Salvar Livro</button>
        </div>
      </form>
    </div>
  </div>

  <!-- SECAO LISTAR LIVROS -->
  <div id="listar-livros" class="secao">
    <div class="cabecalho-dashboard"><h1>Lista de Livros</h1></div>
    <div class="acoes-lista">
      <button type="button" onclick="trocarSecao('livros')" class="botao-voltar">‚Üê Voltar</button>
      <button type="button" onclick="listarLivros()" class="botao-atualizar">Atualizar</button>
        <button type="button" onclick="listarLivrosDisponiveis()" class="botao-disponiveis">Livros dispon√≠veis</button>
    </div>

    <div class="linha">
  <input type="text" id="google-query" placeholder="Pesquisar no Google Books" onkeydown="if(event.key==='Enter'){buscarGoogleBooks()}" />

  <input type="number" id="book-id" placeholder="Digite o ID do livro" onkeydown="if(event.key==='Enter'){buscarLivroPorId()}" />

  <input type="text" id="book-isbn" placeholder="Digite o ISBN do livro" onkeydown="if(event.key==='Enter'){BuscarLivroPorIsbn()}" />
  
  <input type="text" id="book-name" placeholder="Digite o nome do livro" onkeydown="if(event.key=='Enter'){buscarLivroPorNome()}" />

  

</div>

    <div id="lista-livros-container"></div>
  </div>

  <div id="emprestimos" class="secao"><div class="cabecalho-dashboard"><h1>Gerenciar Empr√©stimos</h1></div></div>
  <div id="usuarios" class="secao"><div class="cabecalho-dashboard"><h1>Gerenciar Usu√°rios</h1></div></div>
</div>

<script>
// Trocar se√ß√µes
document.addEventListener("DOMContentLoaded", function () {
  function trocarSecao(novaSecao) {
    document.querySelectorAll(".secao").forEach(secao => secao.classList.remove("ativa"));
    document.getElementById(novaSecao).classList.add("ativa");
  }
  window.trocarSecao = trocarSecao;
  document.getElementById("sair").addEventListener("click", () => { window.location.href = "index.html"; });
});

// Criar livro
document.getElementById('form-livro').addEventListener('submit', function(event) {
  event.preventDefault();
  const formData = new FormData(this);
  const bookData = {
    googleBooksId: formData.get('googleBooksId'),
    title: formData.get('title'),
    authors: formData.get('author'),
    publisher: formData.get('publisher'),
    publishedDate: formData.get('publishedDate'),
    isbn10: formData.get('isbn'),
    isbn13: null,
    description: formData.get('description'),
    pageCount: formData.get('pageCount') ? parseInt(formData.get('pageCount')) : null,
    status: 'AVAILABLE'
  };

  const token = localStorage.getItem('token');
  if (!token) { alert('Erro: Voc√™ precisa estar logado.'); return; }

  fetch('http://localhost:8080/api/books/create', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
    body: JSON.stringify(bookData)
  })
  .then(res => res.ok ? res.json() : Promise.reject(`Erro HTTP: ${res.status}`))
  .then(data => { alert(`Livro "${data.title}" cadastrado com sucesso!`); this.reset(); trocarSecao('livros'); })
  .catch(err => { console.error(err); alert('Erro ao criar livro!'); });
});

// Listar livros
async function listarLivros() {
  const token = localStorage.getItem('token');
  if (!token) { alert('Erro: Voc√™ precisa estar logado.'); return; }
  try {
    const res = await fetch('http://localhost:8080/api/books/list', {
      method: 'GET',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
    const livros = await res.json();
    renderizarLivros(livros);
  } catch (err) { console.error(err); alert('Erro ao carregar livros'); }
}

function renderizarLivros(livros) {
  const container = document.getElementById('lista-livros-container');
  if (!container) return;

  if (!livros || livros.length === 0) {
    container.innerHTML = `<div class="mensagem-vazia"><h3>nenhum livro encontrado</h3><p>Adicione seu primeiro livro √† biblioteca!</p></div>`;
    return;
  }

  container.innerHTML = livros.map(l => `
    <div class="card-livro">
      <h3 class="livro-titulo">${l.title || 'T√≠tulo n√£o informado'}</h3>
      <div class="livro-info">
        <p><strong>ID:</strong> ${l.googleBooksId || l.id || 'N√£o informado'}</p>
        <p><strong>Autor(es):</strong> ${l.authors || 'N√£o informado'}</p>
        <p><strong>Editora:</strong> ${l.publisher || 'N√£o informado'}</p>
        <p><strong>Data de Publica√ß√£o:</strong> ${l.publishedDate || 'N√£o informado'}</p>
        <p><strong>P√°ginas:</strong> ${l.pageCount || 'N√£o informado'}</p>
        <p><strong>ISBN-10:</strong> ${l.isbn10 || 'N√£o informado'}</p>
        <p><strong>ISBN-13:</strong> ${l.isbn13 || 'N√£o informado'}</p>
      </div>
      <div class="livro-descricao">
        <p><strong>Descri√ß√£o:</strong></p>
        <p class="descricao-texto">${l.description || 'Sem descri√ß√£o dispon√≠vel'}</p>
      </div>
    </div>
  `).join('');
}


// Preencher formul√°rio com Google Books ID
async function preencherFormularioPorId() {
  const id = document.getElementById('googleBooksIdInput').value.trim();
  if (!id) { alert('Insira um ID v√°lido!'); return; }

  try {
    const res = await fetch(`https://www.googleapis.com/books/v1/volumes/${encodeURIComponent(id)}`);
    if (!res.ok) throw new Error('Livro n√£o encontrado');
    const data = await res.json();
    const v = data.volumeInfo;

    document.getElementById('title').value = v.title || '';
    document.getElementById('author').value = v.authors ? v.authors.join(', ') : '';
    document.getElementById('publisher').value = v.publisher || '';
    document.getElementById('publishedDate').value = v.publishedDate ? parseInt(v.publishedDate) : '';
    document.getElementById('isbn').value = v.industryIdentifiers?.find(i => i.type === 'ISBN_10')?.identifier || '';
    document.getElementById('description').value = v.description || '';
    document.getElementById('pageCount').value = v.pageCount || '';
  } catch (err) { console.error(err); alert('Erro ao buscar no Google Books!'); }
}

// Buscar Google Books
async function buscarGoogleBooks() {
  const query = document.getElementById('google-query').value.trim();
  if (!query) { alert('Digite algo para buscar!'); return; }

  try {
    const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}`);
    const data = await res.json();
    if (!data.items) { alert('Nenhum livro encontrado'); return; }

    const livros = data.items.map(item => {
      const v = item.volumeInfo;
      return {
        googleBooksId: item.id,
        title: v.title || '',
        authors: v.authors ? v.authors.join(', ') : '',
        publisher: v.publisher || '',
        publishedDate: v.publishedDate || '',
        description: v.description || '',
        pageCount: v.pageCount || null,
        isbn10: v.industryIdentifiers?.find(i => i.type === 'ISBN_10')?.identifier || '',
        isbn13: v.industryIdentifiers?.find(i => i.type === 'ISBN_13')?.identifier || ''
      };
    });

    renderizarLivros(livros);
  } catch (err) { console.error(err); alert('Erro ao buscar no Google Books'); }
}

// Buscar por ID na API local
async function buscarLivroPorId() {
  const query = document.getElementById('book-id').value.trim();
  if (!query) {
    alert('Digite um ID v√°lido!');
    return;
  }

  const token = localStorage.getItem('token');
  try {
    const res = await fetch(`http://localhost:8080/api/books/${encodeURIComponent(query)}`, {
      method: 'GET',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
    });

    if (!res.ok) {
      alert('Nenhum livro encontrado com esse ID!');
      return;
    }

    const livro = await res.json();
    renderizarLivros([livro]);
  } catch (err) {
    console.error(err);
    alert("Erro ao buscar livro por ID!");
  }
}

    async function BuscarLivroPorIsbn() {
        const query = document.getElementById('book-isbn').value.trim();
        if (!query){
            alert('Digite um ISBN v√°lido');
            return;
        }

        const token = localStorage.getItem('token');
        try{
            const res = await fetch(`http://localhost:8080/api/books/isbn/${encodeURIComponent(query)}`, {
           method: 'GET',
           headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
            });

            if(!res.ok){
                alert('Nenhum livro encontrado com esse ISBN');
                return;
            }

            const livros = await res.json();
            renderizarLivros([livros]);
        }catch(err){
            console.error(err);
            alert('Erro ao buscar livro por ISBN');
        }   
    }
  async function buscarLivroPorNome() {
      const query = document.getElementById('book-name').value.trim();
    if(!query){
        alert('Digite um nome v√°lido!');
        return;
    }

    const token = localStorage.getItem('token');
    try{
        const res = await fetch(`http://localhost:8080/api/books/title/${encodeURIComponent(query)}`, {
         headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
            });

            if(!res.ok){
                alert('Nenhum livro encontrado com esse nome!');
                return;
            }

            const livros = await res.json();
            renderizarLivros([livros]);
        }catch(err){
            console.error(err);
            alert('Erro ao buscar livro por nome');
        }  
    } 
  
    async function listarLivrosDisponiveis() {
      const token = localStorage.getItem('token');
    
      try{
        const res = await fetch('http://localhost:8080/api/books/available', {
          method: 'GET',
          headers:{'Content-Type': 'application/json','Authorization': `Bearer ${token}`}
        });

        if(!res.ok){
          alert('Erro ao buscar livros disponiveis');
          return;
        }

   const livros = await res.json();
    if (!Array.isArray(livros)) {
      renderizarLivros([livros]); // caso venha 1 √∫nico livro
    } else {
      renderizarLivros(livros);
    }

  } catch(err) {
    console.error(err);
    alert('Erro ao buscar livros dispon√≠veis');
  }
}

async function listarLivrosDisponiveis() {
  const token = localStorage.getItem('token');

  try {
    const res = await fetch('http://localhost:8080/api/books/available', {
      method: 'GET',
      headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`}
    });

    if (!res.ok) {
      alert('Erro ao buscar livros dispon√≠veis');
      return;
    }

    const livros = await res.json();
    renderizarLivros(livros); // sempre uma lista
  } catch (err) {
    console.error(err);
    alert('Erro ao buscar livros dispon√≠veis');
  }
}

async function buscarLivroPorNome() {
  const query = document.getElementById('book-name').value.trim();
  if (!query) {
    alert('Digite um nome v√°lido!');
    return;
  }

  const token = localStorage.getItem('token');
  try {
    const res = await fetch(`http://localhost:8080/api/books/title/${encodeURIComponent(query)}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      }
    });

    if (!res.ok) {
      alert('Nenhum livro encontrado com esse nome!');
      return;
    }

    const livros = await res.json();

    if (!Array.isArray(livros)) {
      renderizarLivros([livros]);
    } else {
      renderizarLivros(livros);
    }

  } catch (err) {
    console.error(err);
    alert('Erro ao buscar livro por nome');
  }
}


</script>
</body>
</html>

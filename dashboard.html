<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
  <title>√Årea Administrativa</title>
</head>

<body class="dashboard">
  <nav class="navbar">
    <div class="logo">Biblioteca</div>
    <ul class="navbar-links">
      <li><a href="#" onclick="trocarSecao('home')">Home</a></li>
      <li><a href="#" onclick="trocarSecao('livros')">Livros</a></li>
      <li><a href="#" onclick="trocarSecao('emprestimos')">Empr√©stimos</a></li>
      <li><a href="#" onclick="trocarSecao('usuarios')">Usu√°rios</a></li>
    </ul>
    <button type="button" class="sair" id="sair">Logout</button>
  </nav>

  <div class="dashboard-container">
    <!-- SE√á√ÉO HOME -->
    <div id="home" class="secao ativa">
      <div class="cabecalho-dashboard">
        <h1>Bem-vindo √† Biblioteca Virtual</h1>
      </div>
      <p>Escolha uma op√ß√£o do menu acima para come√ßar.</p>
    </div>

    <!-- SE√á√ÉO LIVROS -->
    <div id="livros" class="secao">
      <div class="cabecalho-dashboard"><h1>Gerenciar Livros</h1></div>
      <div class="cards-dashboard">
        <div class="card">
          <h3>Adicionar Livro</h3>
          <p>Cadastrar novo livro</p>
          <button onclick="trocarSecao('adicionar-livro')">Adicionar</button>
        </div>
        <div class="card">
          <h3>Ver Todos</h3>
          <p>Lista completa</p>
          <button onclick="trocarSecao('listar-livros'); listarLivros();">Ver Lista</button>
        </div>
      </div>
    </div>

    <!-- SE√á√ÉO USU√ÅRIOS -->
    <div id="usuarios" class="secao">
      <div class="cabecalho-dashboard"><h1>Gerenciar Usu√°rios</h1></div>
      <div class="cards-dashboard">
        <div class="card">
          <h3>Adicionar Usu√°rio</h3>
          <p>Cadastrar novo usu√°rio</p>
          <button onclick="trocarSecao('adicionar-usuario')">Adicionar</button>
        </div>
        <div class="card">
          <h3>Listar Usu√°rios</h3>
          <p>Visualizar todos os usu√°rios</p>
          <button onclick="trocarSecao('listar-usuarios'); listarUsuarios();">Listar</button>
        </div>
      </div>
    </div>

    <!-- EMPR√âSTIMOS -->
    <div id="emprestimos" class="secao">
      <div class="cabecalho-dashboard"><h1>Gerenciar Empr√©stimos</h1></div>
      <div class="cards-dashboard">
        <div class="card">
          <h3>Listar Empr√©stimos</h3>
          <p>Visualizar Todos os Empr√©stimos Efetuados</p>
          <button onclick="trocarSecao('listar-emprestimos'); listarEmprestimos();">Visualizar</button>
        </div>
        <div class="card">
          <h3>Novo Empr√©stimo</h3>
          <p>Criar Novo Empr√©stimo</p>
          <button onclick="trocarSecao('abrir-emprestimo'); abrirEmprestimo();">Criar</button>
        </div>
      </div>
    </div>

    <!-- ADICIONAR LIVRO -->
    <div id="adicionar-livro" class="secao">
      <div class="cabecalho-dashboard"><h1>Adicionar Novo Livro</h1></div>
      <div class="formulario-livro">
        <form id="form-livro">
          <div class="campo">
            <label for="googleBooksIdInput">Colar ID Google Books:</label>
            <input type="text" id="googleBooksIdInput" name="googleBooksId" placeholder="Cole o ID aqui" />
            <button type="button" onclick="preencherFormularioPorId()" class="botao-google">Buscar</button>
          </div>
          <div class="campo"><label for="title">T√≠tulo:</label><input type="text" id="title" name="title" required /></div>
          <div class="campo"><label for="author">Autor:</label><input type="text" id="author" name="author" required /> </div>
          <div class="campo"><label for="publisher">Editora:</label><input type="text" id="publisher" name="publisher" required /></div>
          <div class="campo"><label for="publishedDate">Ano de publica√ß√£o:</label><input type="number" id="publishedDate" name="publishedDate" required /></div>
          <div class="campo"><label for="isbn">ISBN:</label><input type="text" id="isbn" name="isbn" required /></div>
          <div class="campo"><label for="description">Descri√ß√£o:</label><input type="text" id="description" name="description" required /></div>
          <div class="campo"><label for="pageCount">N√∫mero de p√°ginas:</label><input type="number" id="pageCount" name="pageCount" required /></div>
          <div class="caixa-botoes">
            <button type="button" onclick="trocarSecao('livros')" class="botao-voltar">‚Üê Voltar</button>
            <button type="submit" class="botaoo-salvar">üíæ Salvar Livro</button>
          </div>
        </form>
      </div>
    </div>

    <!-- LISTAR LIVROS -->
    <div id="listar-livros" class="secao">
      <div class="cabecalho-dashboard"><h1>Lista de Livros</h1></div>
      <div class="acoes-lista">
        <button type="button" onclick="trocarSecao('livros')" class="botao-voltar">‚Üê Voltar</button>
        <button type="button" onclick="listarLivros()" class="botao-atualizar">Atualizar</button>
        <button type="button" onclick="listarLivrosDisponiveis()" class="botao-disponiveis">Livros dispon√≠veis</button>
      </div>
      <div class="linha">
        <input type="text" id="google-query" placeholder="Pesquisar no Google Books" onkeydown="if(event.key==='Enter'){buscarGoogleBooks()}" />
        <input type="number" id="book-id" placeholder="Digite o ID do livro" onkeydown="if(event.key==='Enter'){buscarLivroPorId()}" />
        <input type="text" id="book-isbn" placeholder="Digite o ISBN do livro" onkeydown="if(event.key==='Enter'){buscarLivroPorIsbn()}" />
        <input type="text" id="book-name" placeholder="Digite o nome do livro" onkeydown="if(event.key=='Enter'){buscarLivroPorNome()}" />
      </div>
      <div id="lista-livros-container"></div>
    </div>

    <!-- ADICIONAR USU√ÅRIO -->
    <div id="adicionar-usuario" class="secao">
      <div class="cabecalho-dashboard"><h1>Adicionar Usu√°rio</h1></div>
      <form id="form-usuario">
        <div class="campo"><label for="nome">Nome:</label><input type="text" id="nome" name="nome" required /></div>
        <div class="campo"><label for="email">E-mail:</label><input type="email" id="email" name="email" required /></div>
        <div class="campo"><label for="login">Login:</label><input type="text" id="login" name="login" required /></div>
        <div class="campo"><label for="senha">Senha:</label><input type="password" id="senha" name="password" required /></div>
        <div class="campo"><label for="endereco">Endere√ßo:</label><input type="text" id="endereco" name="endereco" required /></div>
        <div class="campo"><label for="telefone">Telefone:</label><input type="tel" id="telefone" name="telefone" required /></div>
        <div class="campo">
          <label for="tipo">Tipo de Usu√°rio:</label>
          <select id="tipo" name="tipo" required>
         <option value="">Selecione o tipo de usu√°rio</option>
            <option value="admin">Administrador</option>
            <option value="bibliotecario">Bibliotec√°rio</option>
            <option value="usuario">Usu√°rio Comum</option>

          </select>
        </div>
        <div class="caixa-botoes">
          <button type="button" onclick="trocarSecao('usuarios')" class="botao-voltar">‚Üê Voltar</button>
          <button type="submit" class="botaoo-salvar">üíæ Salvar Usu√°rio</button>
        </div>
      </form>
    </div>

    <!-- LISTAR USU√ÅRIOS -->
    <div id="listar-usuarios" class="secao">
      <div class="cabecalho-dashboard"><h1>Lista de Usu√°rios</h1></div>
      <div class="acoes-lista">
        <button type="button" onclick="trocarSecao('usuarios')" class="botao-voltar">‚Üê Voltar</button>
        <button type="button" onclick="listarUsuarios()" class="botao-atualizar">Atualizar Lista</button>
      </div>
      <div class="linha">
        <input type="number" id="user-id" placeholder="Buscar por ID" onkeydown="if(event.key==='Enter'){buscarUsuarioPorId()}" />
        <input type="text" id="user-login" placeholder="Buscar por login" onkeydown="if(event.key==='Enter'){buscarUsuarioPorLogin()}" />
      </div>
      <div id="lista-usuarios-container"></div>
    </div>
  </div>

  <script>
    // ==================== CONFIGURA√á√ïES ====================
    const API_BASE = 'http://localhost:8080/api';

    // ==================== UTILIT√ÅRIOS ====================
    function getToken() {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Erro: Voc√™ precisa estar logado.');
        throw new Error('Token n√£o encontrado');
      }
      return token;
    }

    async function makeRequest(endpoint, options = {}, useAuth = true) {
  const config = {
    headers: {
      'Content-Type': 'application/json',
      ...(useAuth ? { 'Authorization': `Bearer ${getToken()}` } : {}),
      ...options.headers
    },
    ...options
  };


     const url = useAuth ? `${API_BASE}${endpoint}` : endpoint;
  const response = await fetch(url, config);
  if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
  return response.json();
}
    function showSuccess(message) {
      alert(message);
    }

    function showError(message) {
      alert(message);
    }

    // ==================== NAVEGA√á√ÉO ====================
    function trocarSecao(novaSecao) {
      document.querySelectorAll('.secao').forEach(secao => secao.classList.remove('ativa'));
      document.getElementById(novaSecao).classList.add('ativa');
    }

    // ==================== LIVROS ====================
    async function criarLivro(bookData) {
      return await makeRequest('/books/create', {
        method: 'POST',
        body: JSON.stringify(bookData)
      });
    }

    async function listarLivros() {
      try {
        const livros = await makeRequest('/books/list');
        renderizarLivros(livros);
      } catch (error) {
        showError('Erro ao carregar livros');
      }
    }

    async function buscarLivroPorId() {
      const query = document.getElementById('book-id').value.trim();
      if (!query) return showError('Digite um ID v√°lido!');

      try {
        const livro = await makeRequest(`/books/${encodeURIComponent(query)}`);
        renderizarLivros([livro]);
      } catch (error) {
        showError('Nenhum livro encontrado com esse ID!');
      }
    }

    async function buscarLivroPorIsbn() {
      const query = document.getElementById('book-isbn').value.trim();
      if (!query) return showError('Digite um ISBN v√°lido');

      try {
        const livros = await makeRequest(`/books/isbn/${encodeURIComponent(query)}`);
        renderizarLivros(Array.isArray(livros) ? livros : [livros]);
      } catch (error) {
        showError('Nenhum livro encontrado com esse ISBN');
      }
    }

    async function buscarLivroPorNome() {
      const query = document.getElementById('book-name').value.trim();
      if (!query) return showError('Digite um nome v√°lido!');

      try {
        const livros = await makeRequest(`/books/title/${encodeURIComponent(query)}`);
        renderizarLivros(Array.isArray(livros) ? livros : [livros]);
      } catch (error) {
        showError('Nenhum livro encontrado com esse nome!');
      }
    }

    async function listarLivrosDisponiveis() {
      try {
        const livros = await makeRequest('/books/available');
        renderizarLivros(Array.isArray(livros) ? livros : [livros]);
      } catch (error) {
        showError('Erro ao buscar livros dispon√≠veis');
      }
    }

    async function preencherFormularioPorId() {
      const id = document.getElementById('googleBooksIdInput').value.trim();
      if (!id) return showError('Insira um ID v√°lido!');
      
      try {
        const response = await fetch(`https://www.googleapis.com/books/v1/volumes/${encodeURIComponent(id)}`);
        if (!response.ok) throw new Error('Livro n√£o encontrado');
        const data = await response.json();
        const v = data.volumeInfo;

        document.getElementById('title').value = v.title || '';
        document.getElementById('author').value = v.authors ? v.authors.join(', ') : '';
        document.getElementById('publisher').value = v.publisher || '';
        document.getElementById('publishedDate').value = v.publishedDate ? parseInt(v.publishedDate) : '';
        document.getElementById('isbn').value = v.industryIdentifiers?.find(i => i.type === 'ISBN_10')?.identifier || '';
        document.getElementById('description').value = v.description || '';
        document.getElementById('pageCount').value = v.pageCount || '';
      } catch (error) {
        showError('Erro ao buscar no Google Books!');
      }
    }

    async function buscarGoogleBooks() {
      const query = document.getElementById('google-query').value.trim();
      if (!query) return showError('Digite algo para buscar!');

      try {
        const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        if (!data.items) return showError('Nenhum livro encontrado');

        const livros = data.items.map(item => {
          const v = item.volumeInfo;
          return {
            googleBooksId: item.id,
            title: v.title || '',
            authors: v.authors ? v.authors.join(', ') : '',
            publisher: v.publisher || '',
            publishedDate: v.publishedDate || '',
            description: v.description || '',
            pageCount: v.pageCount || null,
            isbn10: v.industryIdentifiers?.find(i => i.type === 'ISBN_10')?.identifier || '',
            isbn13: v.industryIdentifiers?.find(i => i.type === 'ISBN_13')?.identifier || ''
          };
        });

        renderizarLivros(livros);
      } catch (error) {
        showError('Erro ao buscar no Google Books');
      }
    }

    function renderizarLivros(livros) {
      const container = document.getElementById('lista-livros-container');
      if (!container) return;
      
      if (!livros || livros.length === 0) {
        container.innerHTML = '<div class="mensagem-vazia"><h3>Nenhum livro encontrado</h3><p>Adicione seu primeiro livro √† biblioteca!</p></div>';
        return;
      }

      container.innerHTML = livros.map(l => `
        <div class="card-livro">
          <h3 class="livro-titulo">${l.title || 'T√≠tulo n√£o informado'}</h3>
          <div class="livro-info">
            <p><strong>ID:</strong> ${l.googleBooksId || l.id || 'N√£o informado'}</p>
            <p><strong>Autor(es):</strong> ${l.authors || 'N√£o informado'}</p>
            <p><strong>Editora:</strong> ${l.publisher || 'N√£o informado'}</p>
            <p><strong>Data de Publica√ß√£o:</strong> ${l.publishedDate || 'N√£o informado'}</p>
            <p><strong>P√°ginas:</strong> ${l.pageCount || 'N√£o informado'}</p>
            <p><strong>ISBN-10:</strong> ${l.isbn10 || 'N√£o informado'}</p>
            <p><strong>ISBN-13:</strong> ${l.isbn13 || 'N√£o informado'}</p>
          </div>
          <div class="livro-descricao">
            <p><strong>Descri√ß√£o:</strong></p>
            <p class="descricao-texto">${l.description || 'Sem descri√ß√£o dispon√≠vel'}</p>
          </div>
        </div>
      `).join('');
    }

    // ==================== USU√ÅRIOS ====================

    document.getElementById('form-usuario').addEventListener('submit', cadastrarUsuario); 
      
    async function cadastrarUsuario(event) {
    event.preventDefault();
    
    const nome = document.getElementById('nome').value;
    const email = document.getElementById('email').value;
    const login = document.getElementById('login').value;
    const password = document.getElementById('senha').value;
    const endereco = document.getElementById('endereco').value;
    const telefone = document.getElementById('telefone').value;
    const tipo = document.getElementById('tipo').value;

    if (!nome || !email || !login || !password || !endereco || !telefone || !tipo) {
              alert("Todos os campos s√£o obrigat√≥rios!");
              return;
            }
    
            let role;
            switch(tipo){
              case "admin":
              role = "ADMIN";
              break;
                 case "bibliotecario":
                role = "LIBRARIAN";
                break;
              case "usuario":
                role = "USER";
                break;
              default:
                role = "USER";
            }

            const userData = {nome, email, login, password, endereco, telefone, role};
            console.log("Dados a serem enviados:", userData);

            try{
              const response = await fetch("http://localhost:8080/auth/register", {
             method: 'POST',
             headers: {"Content-Type":"application/json"},
             body: JSON.stringify(userData)
            });

            if(!response.ok) throw new Error('Erro na requisi√ß√£o');
            const data = await response.json();
            alert(`Usu√°rio cadastrado com sucesso!`);
            this.reset();
    }catch(error){
      alert('Erro ao cadastrar usu√°rio');
      console.error(error);
    }
    };

    async function listarUsuarios() {
      try {
        const usuarios = await makeRequest('/users/list');
        renderizarUsuarios(usuarios);
      } catch (error) {
        showError('Erro ao listar usu√°rios');
      }
    }

    async function buscarUsuarioPorId() {
      const id = document.getElementById('user-id').value.trim();
      if (!id) return showError('Digite um ID v√°lido!');

      try {
        const usuario = await makeRequest(`/users/${id}`);
        renderizarUsuarios([usuario]);
      } catch (error) {
        showError('Usu√°rio n√£o encontrado!');
      }
    }

    async function buscarUsuarioPorLogin() {
      const login = document.getElementById('user-login').value.trim();
      if (!login) return showError('Digite um login v√°lido!');

      try {
        const usuario = await makeRequest(`/users/login/${encodeURIComponent(login)}`);
        renderizarUsuarios([usuario]);
      } catch (error) {
        showError('Usu√°rio n√£o encontrado!');
      }
    }

    function renderizarUsuarios(usuarios) {
      const container = document.getElementById('lista-usuarios-container');
      if (!container) return;

      if (!usuarios || usuarios.length === 0) {
        container.innerHTML = '<div class="mensagem-vazia"><h3>Nenhum usu√°rio encontrado</h3></div>';
        return;
      }

      container.innerHTML = usuarios.map(u => `
        <div class="card-usuario">
          <p><strong>ID:</strong> ${u.id || 'N√£o informado'}</p>
          <p><strong>Nome:</strong> ${u.nome || 'N√£o informado'}</p>
          <p><strong>Login:</strong> ${u.login || 'N√£o informado'}</p>
          <p><strong>Email:</strong> ${u.email || 'N√£o informado'}</p>
          <p><strong>Endere√ßo:</strong> ${u.endereco || 'N√£o informado'}</p>
          <p><strong>Telefone:</strong> ${u.telefone || 'N√£o informado'}</p>
         <p><strong>Tipo:</strong> ${u.role ? u.role.replace('ROLE_', '') : 'N√£o informado'}</p>

        </div>
      `).join('');
    }

    // ==================== EVENT LISTENERS ====================
    document.addEventListener("DOMContentLoaded", function() {
      // Logout
      document.getElementById("sair").addEventListener("click", () => {
        localStorage.removeItem('token');
        window.location.href = "index.html";
      });

      // Form de livros
      document.getElementById('form-livro').addEventListener('submit', async function(event) {
        event.preventDefault();
        try {
          const formData = new FormData(this);
          const bookData = {
            googleBooksId: formData.get('googleBooksId'),
            title: formData.get('title'),
            authors: formData.get('author'),
            publisher: formData.get('publisher'),
            publishedDate: formData.get('publishedDate'),
            isbn10: formData.get('isbn'),
            isbn13: null,
            description: formData.get('description'),
            pageCount: formData.get('pageCount') ? parseInt(formData.get('pageCount')) : null,
            status: 'AVAILABLE'
          };

          const data = await criarLivro(bookData);
          showSuccess(`Livro "${data.title}" cadastrado com sucesso!`);
          this.reset();
          trocarSecao('livros');
        } catch (error) {
          showError('Erro ao criar livro!');
        }
      });

      // Form de usu√°rios
   /**   document.getElementById('form-usuario').addEventListener('submit', async function(event) {
        event.preventDefault();
        try {
          const formData = new FormData(this);
          const userData = {
            nome: formData.get('nome'),
            email: formData.get('email'),
            login: formData.get('login'),
            password: formData.get('senha'),
            endereco: formData.get('endereco'),
            telefone: formData.get('telefone'),
            tipo: formData.get('tipo')
          };

          const data = await criarUsuario(userData);
          showSuccess(`Usu√°rio "${data.nome}" cadastrado com sucesso!`);
          this.reset();
          trocarSecao('usuarios');
        } catch (error) {
          showError('Erro ao criar usu√°rio!');
        }
      }); **/
    });
  </script>
</body>
</html>